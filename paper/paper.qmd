---
title: "Alberta Mortality 2000 to 2022"
subtitle: "My subtitle if needed"
author: 
  - Yihang Cai
thanks: "Code and data are available at: https://github.com/peachvegetable/Alberta-mortality"
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| message: false
#| echo: false
#| warning: false

# load packages
library(tidyverse)
library(ggplot2)
library(janitor)
library(dplyr)
library(readr)
library(knitr)
library(modelsummary)
library(boot)
library(broom.mixed)
library(bayesplot)
library(loo)
```


# Introduction



# Data {#sec-data}

Our data is from Alberta Government opendata, the dataset includes a ranking of the 30 most common causes of death each year in Alberta starts from 2000 to 2022, by ranking and total number of deaths [@citeAlberta]. 

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-top5causes
#| fig-cap: Top 5 causes of deaths from 2000 to 2022, for Alberta, Canada

alberta_cod <- read_csv("../data/analysis_data/analysis_data.csv")

# Identify causes of death that have been recorded in each of the 22 years before 2022
causes_in_all_years <- alberta_cod |>
  group_by(cause) |>
  summarize(count_years = n_distinct(calendar_year)) |>
  filter(count_years == 22) |>
  ungroup() |>
  select(cause)

# Find the top five causes of death in 2022 from those that have been present in all previous years
alberta_cod_top_five <- alberta_cod |>
  filter(calendar_year == 2022, cause %in% causes_in_all_years$cause) |>
  slice_max(order_by = desc(ranking), n = 5) |>
  pull(cause)

# Filter the original 'alberta_cod' dataset to include only the top five causes
alberta_cod <- alberta_cod |>
  filter(cause %in% alberta_cod_top_five)

alberta_cod |>
  ggplot(aes(x = calendar_year, y = total_deaths, color = cause)) +
  geom_line() +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Annual number of deaths in Alberta") +
  facet_wrap(vars(cause), dir = "v", ncol = 1) +
  theme(legend.position = "none")
```


# Model


## Model set-up

Two models generated, one follows poisson distribution and another follows negative binomial distribution. We are interested in how total number of deaths differs by different causes of deaths.

Define $y_i$ as the total number of deaths for the i-th observation. Then $\beta_0$ is the expected log count of total deaths when none of the causes in the model are present. It's the starting point of the model's prediction. 

\begin{align*} 
y_i|\lambda_i &\sim \mbox{Poisson}(\lambda_i) \\
\log(\lambda_i) & = \beta_0 + \beta_1 \times \mbox{cause}_i\\
\beta_0 & \sim \mbox{Normal}(0, 2.5)\\
\beta_1 & \sim \mbox{Normal}(0, 2.5)
\end{align*}

Define $y_i$ as the total deaths for the i-th observation. $\theta$ is the additional parameter to model overdispersion. $\mu_i$ is the mean of the Negative Binomial distribution for the i-th observation, $\beta_0$ is the intercept, and $\beta_1$ represents the effect of each cause of death.

\begin{align*} 
y_i|\lambda_i, \theta &\sim \mbox{NegativeBinomial}(\mu_i, \theta) \\
\log(\mu_i) & = \beta_0 + \beta_1 \times \mbox{cause}_i\\
\beta_0 & \sim \mbox{Normal}(0, 2.5)\\
\beta_1 & \sim \mbox{Normal}(0, 2.5) \\
\theta & \sim \mbox{SomePrior}(.)
\end{align*}

We run the model in R [@citeR] using the `rstanarm` package of [@citeRstanarm]. We use the default priors from `rstanarm`.

We calculate the total number of deaths by the formula

\begin{equation}
\text{total deaths} = e^{\beta_0 + \sum_{i = 0}^{5} \beta_i X_i}
\label{eq:total_deaths_formula}
\end{equation}

Where $X_1$, $X_2$, $X_3$, $X_4$, and $X_5$ represent $X_{\text{Acute myocardial infarction}}$, $X_{\text{All other forms of chronic}}$, $X_{\text{Malignant neoplasms}}$, $X_{\text{Organic dementia}}$, and $X_{\text{Other chronic}}$ respectively.



## Model summary

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-modelsummary
#| tbl-cap: Modeling the cause deaths in Alberta, 2000 - 2022

poisson_model = readRDS("../models/poisson_model.rds")
neg_binomial_model = readRDS("../models/neg_binomial_model.rds")

modelsummary(
  list(
    "Poisson" = poisson_model,
    "Negative binomial" = neg_binomial_model
  )
)
```


```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-ppcheckpoissonvsbinomial
#| layout-ncol: 2
#| fig-cap: "Comparing Poisson and negative binomial models"
#| fig-subcap: ["Poisson model", "Negative binomial model"]

pp_check(poisson_model) +
  theme(legend.position = "bottom")

pp_check(neg_binomial_model) +
  theme(legend.position = "bottom")
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-elpdtable
#| tbl-cap: "ELPD table"


poisson <- loo(poisson_model, cores = 2)
neg_binomial <- loo(neg_binomial_model, cores = 2)

loo_compare(poisson, neg_binomial)
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-confidenceinterval
#| layout-ncol: 2
#| fig-cap: "90% Confidence Interval"
#| fig-subcap: ["Poisson model", "Negative binomial model"]

modelplot(poisson_model, conf_level = 0.9) +
  labs(x = "90 per cent credibility interval")

modelplot(neg_binomial_model, conf_level = 0.9) +
  labs(x = "90 per cent credibility interval")
```



# Results





# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check


## Diagnostics




\newpage


# References


