---
title: "Alberta Mortality 2000 to 2022"
subtitle: "My subtitle if needed"
author: 
  - Yihang Cai
thanks: "Code and data are available at: https://github.com/peachvegetable/Alberta-mortality"
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| message: false
#| echo: false
#| warning: false

# load packages
library(rstanarm)
library(tidyverse)
library(ggplot2)
library(janitor)
library(dplyr)
library(readr)
library(knitr)
library(modelsummary)
library(boot)
library(broom.mixed)
library(loo)
```


# Introduction {#sec-intro}

The COVID-19 pandemic has profoundly impacted global health, becoming a prominent cause of mortality with over 19,700 Canadians dying to the virus in 2022, marking the highest annual death toll since the pandemic's onset [@citeICI]. This stark statistic places COVID-19 among the leading causes of death in Canada since 2020. Beyond the pandemic, however, numerous other factors contribute to mortality rates, prompting an investigation into the primary causes of death preceding the emergence of COVID-19. This paper focuses on Alberta, a Canadian province that has maintained detailed records of mortality causes since 2001, offering a comprehensive dataset of the top 30 causes of death annually from 2001 to 2022.

This research endeavors to analyze the top five causes of death over the past 22 years in Alberta, quantifying their relative contributions to the overall mortality rate. To this end, we employ two statistical models: the Poisson distribution model and the Negative binomial distribution model. The choice of dual models allows for a nuanced analysis, accommodating the data's variability and overdispersion, with the ultimate goal of identifying the model that best combines accuracy and precision in reflecting the underlying trends.

Data for this study were sourced from the Alberta Government's open data portal, focusing on explaining the relationship between individual causes of death and the total mortality rate. This analysis seeks to determine the estimand, a statistical term denoting the quantity of interest that our models aim to estimate.

The structure of this paper is designed to guide the reader through our research journey, starting with Section @sec-intro, which introduces the study's context, objectives, and preliminary observations. Section @sec-data presents visualizations of the changing landscape of mortality causes from 2001 to 2022, accompanied by a detailed description of the dataset. Section @sec-model delves into the methodology, clarifying the statistical models employed in our analysis. The findings and their statistical examination are detailed in @sec-results, while @sec-discussion discusses these results, reflecting on the study's limitations and proposing avenues for future research.



# Data {#sec-data}

Data for this study were prepared and analyzed using R [@citeR], grasping several packages including Tidyverse [@citeTidyverse] for data manipulation, ggplot2 [@citeGgplot2] for visualization, Janitor [@citeJanitor] for data cleaning, Readr [@citeReadr] for data import, Dplyr [@citeDplyr] for data manipulation, Knitr [@citeKnitr] for dynamic reporting, Modelsummary [@citeModelsummary] for summarizing model outputs, and Rstanarm [@citeRstanarm] for Bayesian modeling.

Our analysis focuses on the Alberta Government's open data, encompassing annual records of the top 30 causes of death from 2001 to 2022 [@citeAlberta]. This comprehensive dataset sheds light on mortality trends in Alberta, offering insights into the dominant health challenges before the onset of the COVID-19 pandemic. Such an extensive temporal range is crucial for identifying long-term trends and shifts in public health priorities.

The dataset's primary variables include 'calendar_year' (renamed to 'Yaer'), capturing the range from 2001 to 2022; 'cause' (renamed to 'Cause'), listing the top 30 distinct causes of death annually; and 'total_deaths' (renamed to 'Deaths'), representing the yearly mortality count per cause. Initial data cleaning involved condensing the lengthy cause-of-death labels to ensure clarity in visualization. Furthermore, our analysis strategically omits causes not consistently present over the 22-year span, such as COVID-19, to maintain a focus on long-term trends and ensure analytical consistency.

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-top10causes2022
#| tbl-cap: Top 10 causes of deaths in 2022, Alberta

alberta_cod <- read.csv("../data/analysis_data/analysis_data.csv")

alberta_cod |>
  filter(
    calendar_year == 2022,
    ranking <= 10
  ) |>
  mutate(total_deaths = format(total_deaths, big.mark = ",")) |>
  kable(
    col.names = c("Year", "Cause", "Ranking", "Deaths", "Years"),
    align = c("l", "r", "r", "r", "r"),
    digits = 0, booktabs = TRUE, linesep = ""
  )

```

@tbl-top10causes2022 presents data from Alberta for the year 2022, focusing on the top 10 causes of death. Each row in the table lists a specific cause of death, its rank in terms of mortality for that year, the number of deaths attributed to that cause, and the number of years that particular cause has appeared in the top 10 list out of the 22-year period studied.

For instance, the top cause of death for 2022 is listed as "Organic dementia," which caused 2,377 deaths and has been among the top 10 causes for all 22 years analyzed. The fifth cause is "COVID-19, virus identified" with 1,547 deaths, but it has only been in the top 10 causes for 3 years, corresponding to the recent years of the pandemic.

We can use this table for quickly identifying the most significant health concerns in Alberta in 2022 and assessing their persistence over time.

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-top5causes
#| fig-cap: Top 5 causes of deaths from 2000 to 2022, for Alberta, Canada

alberta_cod <- read_csv("../data/analysis_data/analysis_data.csv")

# Identify causes of death that have been recorded in each of the 22 years before 2022
causes_in_all_years <- alberta_cod |>
  group_by(cause) |>
  summarize(count_years = n_distinct(calendar_year)) |>
  filter(count_years == 22) |>
  ungroup() |>
  select(cause)

# Find the top five causes of death in 2022 from those that have been present in all previous years
alberta_cod_top_five <- alberta_cod |>
  filter(calendar_year == 2022, cause %in% causes_in_all_years$cause) |>
  slice_max(order_by = desc(ranking), n = 5) |>
  pull(cause)

# Filter the original 'alberta_cod' dataset to include only the top five causes
alberta_cod <- alberta_cod |>
  filter(cause %in% alberta_cod_top_five)

alberta_cod |>
  ggplot(aes(x = calendar_year, y = total_deaths, color = cause)) +
  geom_line() +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Annual number of deaths in Alberta") +
  facet_wrap(vars(cause), dir = "v", ncol = 1) +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 6)
        )
```

@fig-top5causes shows a multi-line graph depicting the annual number of deaths in Alberta for various causes from 2001 to 2022. Acute Myocardial Infarction (Heart Attack): The line appears relatively flat, which indicates that the number of deaths from heart attacks has remained consistent over the 22-year period. There is no significant upward or downward trend, suggesting stable incidence or improvements in treatment may be offsetting the risk factors in the population. All Other Forms of Chronic Diseases: This category shows a slight downward trend, indicating a small decrease in the number of deaths over time. This could be due to better management of chronic diseases or changes in diagnostic criteria and classification. Malignant Neoplasms of Trachea, Bronchus, and Lung (Lung Cancer): The line is fairly stable with a slight increase, suggesting a small rise in mortality from lung cancer over the years. This could reflect population growth, aging, or lifestyle factors influencing disease rates. Organic Dementia: There is a noticeable upward trend in deaths due to organic dementia. This is likely reflective of an aging population and increased diagnosis rates, as well as potentially increased prevalence of the disease. Other Chronic Obstructive Pulmonary Diseases (COPD): The trend for COPD is relatively stable with a very slight increase, indicating mortality rates from COPD have remained somewhat constant, potentially reflecting better treatments balancing out any increases in prevalence. When comparing the slopes of the lines, organic dementia shows the most significant increase, potentially indicating it is becoming a more prevalent cause of death. Acute myocardial infarction and COPD display relative stability compared to other causes, suggesting that the impact of these conditions on mortality rates has not changed markedly. The slight decline in 'All Other Forms of Chronic Diseases' could reflect effective public health interventions or improvements in healthcare delivery. 

# Model {#sec-model}


## Model set-up

Two models generated, one follows poisson distribution and another follows negative binomial distribution. We are interested in how total number of deaths differs by different causes of deaths.

Define $y_i$ as the total number of deaths for the i-th observation. Then $\beta_0$ is the expected log count of total deaths when none of the causes in the model are present. It's the starting point of the model's prediction. 

\begin{align*} 
y_i|\lambda_i &\sim \mbox{Poisson}(\lambda_i) \\
\log(\lambda_i) & = \beta_0 + \beta_1 \times \mbox{cause}_i\\
\beta_0 & \sim \mbox{Normal}(0, 2.5)\\
\beta_1 & \sim \mbox{Normal}(0, 2.5)
\end{align*}

Define $y_i$ as the total deaths for the i-th observation. $\theta$ is the additional parameter to model overdispersion. $\mu_i$ is the mean of the Negative Binomial distribution for the i-th observation, $\beta_0$ is the intercept, and $\beta_1$ represents the effect of each cause of death.

\begin{align*} 
y_i|\lambda_i, \theta &\sim \mbox{NegativeBinomial}(\mu_i, \theta) \\
\log(\mu_i) & = \beta_0 + \beta_1 \times \mbox{cause}_i\\
\beta_0 & \sim \mbox{Normal}(0, 2.5)\\
\beta_1 & \sim \mbox{Normal}(0, 2.5) \\
\theta & \sim \mbox{SomePrior}(.)
\end{align*}

We run the model in R [@citeR] using the rstanarm package of [@citeRstanarm].

We calculate the total number of deaths by the formula

\begin{equation}
\text{total deaths} = e^{\beta_0 + \sum_{i = 0}^{5} \beta_i X_i}
\label{eq:total_deaths_formula}
\end{equation}

Where $X_1$, $X_2$, $X_3$, $X_4$, and $X_5$ represent $X_{\text{Acute myocardial infarction}}$, $X_{\text{All other forms of chronic}}$, $X_{\text{Malignant neoplasms}}$, $X_{\text{Organic dementia}}$, and $X_{\text{Other chronic}}$ respectively.



## Model summary

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-modelsummary
#| tbl-cap: Modeling the cause deaths in Alberta, 2000 - 2022

poisson_model = readRDS("../models/poisson_model.rds")
neg_binomial_model = readRDS("../models/neg_binomial_model.rds")

modelsummary(
  list(
    "Poisson" = poisson_model,
    "Negative binomial" = neg_binomial_model
  )
)
```


```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-ppcheckpoissonvsbinomial
#| layout-ncol: 2
#| fig-cap: "Comparing Poisson and negative binomial models"
#| fig-subcap: ["Poisson model", "Negative binomial model"]

pp_check(poisson_model) +
  theme(legend.position = "bottom")

pp_check(neg_binomial_model) +
  theme(legend.position = "bottom")
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: tbl-elpdtable
#| tbl-cap: "ELPD table"


poisson <- loo(poisson_model, cores = 2)
neg_binomial <- loo(neg_binomial_model, cores = 2)

loo_compare(poisson, neg_binomial)
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-confidenceinterval
#| layout-ncol: 2
#| fig-cap: "90% Confidence Interval"
#| fig-subcap: ["Poisson model", "Negative binomial model"]

modelplot(poisson_model, conf_level = 0.9) +
  labs(x = "90 per cent credibility interval")

modelplot(neg_binomial_model, conf_level = 0.9) +
  labs(x = "90 per cent credibility interval")
```



# Results {#sec-results}





# Discussion {#sec-discussion}

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check


## Diagnostics




\newpage


# References


